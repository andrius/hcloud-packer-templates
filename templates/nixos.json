{
    "variables": {
        "hcloud_token": "{{ env `HCLOUD_TOKEN` }}",
        "nix-signing-keys": "B541D55301270E0BCF15CA5D8170B4726D7198DE",
        "nix-install-url": "https://nixos.org/releases/nix/nix-2.2.2/install",
        "nix-channel": "https://nixos.org/channels/nixos-19.03",
        "system-keymap": "dvorak-programmer",
        "system-locale": "en_US.UTF-8",
        "system-timezone": "UTC",
        "root-ssh-key": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCo31gjjKXTeVYH6Oy7xGqT7rfsBkhLOFDsDEwkfNvVP8jzobumSPfIlBVKLAYU3A+5lPlICLVfnkGSIkLO+fLb3c54HQ8GHb2R/+cq5N/JicMu7LAmYy7ADF7cwl8UklLYm9i2UrZtsD+Xi/2KeGWqpbscs6HNqOoQjoOrQHOqpJW0kaAr+IgMEL+ECh1/loS4J3cVTk9Xi+jZbNDRR8BtqZ9WEpYSftqGLNHeRTYq35kw0FkV5CKhDoKBDLyTHU/sSyic7NpIWd7MI0CzMYmb5bSAdW19KdgNbz4Y+yvZsD9LZ6rvy4MbwWXAL0f/kSKMxh7Zw57sYmgf0Q8O6LIc5cR/kzs63FChWyoIHEhbtzC0kSNatCrN6UYG/cHehUvdpQVzf5zuvlErw0C4NxYth8l5QrcwoOKQNeiRYOivyUaiKEtcVmv9KD91IPhzwCv3v6DVhfc61gmjRL/G4Ipzv61M9zGJXLfOytxQ6uZVkfIQ9em+/YqVyWV/TezprYhLVwHPZ5c9/qLvnPRidrCAJxGUdtB3LHM2swsAmx1cS8m5jxggWIBmwZB5uxCliF2XHXu0+rUmmi0sTX4EcL5HlXuzMBW3vtKVTy4kGHqvNjIQx7GGcs4Bfp3qfR893a1xrZQoOAeuLvwGDa1otAQLPsZw4nuA8XFpg0GP35bvGQ== openpgp:0xB487F34B"
    },

    "builders": [{
        "type": "hcloud",
        "ssh_username": "root",

        "token": "{{ user `hcloud_token` }}",
        "image": "debian-9",
        "location": "hel1",
        "server_type": "cx11",
        
        "snapshot_name": "nixos-{{ timestamp }}",
        "rescue": "linux64"
    }],

    "provisioners": [
        {
            "type": "shell",
            "script": "install/filesystem.sh",
            "environment_vars": [
                "LABEL=nixos-{{ timestamp }}"
            ]
        },    
        {
            "type": "shell",
            "script": "install/nixos.sh",
            "environment_vars": [
                "NIX_SIGNING_KEYS={{ user `nix-signing-keys` }}",
                "NIX_INSTALL_URL={{ user `nix-install-url` }}",
                "NIX_CHANNEL={{ user `nix-channel` }}",
                "ROOT_SSH_KEY={{ user `root-ssh-key` }}",
                "KEYMAP={{ user `system-keymap` }}",
                "LOCALE={{ user `system-locale` }}",
                "TIMEZONE={{ user `system-timezone` }}"
            ]
        }
    ],

    "post-processors": [{
        "type": "manifest",
        "output": "nixos-manifest.json"
    }]
}
